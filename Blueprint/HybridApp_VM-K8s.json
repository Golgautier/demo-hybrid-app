{"status":{},"spec":{"name":"HybridApp_VM-K8s","description":"Deploy an app with a frontend part on k8s, and a backend databse in a VM \nWhen app is runnning, you can connect on it with http:\/\/@@{ShortName}@@.ntnxlab.org","resources":{"service_definition_list":[{"name":"Backend","description":"","variable_list":[],"action_list":[{"type":"system","name":"action_create","description":"System action for creating an application","runbook":{"name":"a8445363_runbook","description":"","task_definition_list":[{"type":"DAG","name":"9cebc9fd_dag","description":"","attrs":{"type":"","edges":[{"type":"","from_task_reference":{"name":"Create DB","kind":"app_task"},"to_task_reference":{"name":"Init DB content","kind":"app_task"},"edge_type":"user_defined"}]},"child_tasks_local_reference_list":[{"name":"Create DB","kind":"app_task"},{"name":"Init DB content","kind":"app_task"}],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Create DB","description":"","attrs":{"type":"","script":"#!\/bin\/bash -x\n\nsudo mariadb -u root <<EOF\nCREATE DATABASE @@{DBName}@@;\nSHOW DATABASES;\nCREATE USER '@@{MariaDBCred.username}@@'@'%' IDENTIFIED BY '@@{MariaDBCred.secret}@@';\nCREATE USER '@@{NUTANIX.username}@@'@'localhost' IDENTIFIED BY '@@{NUTANIX.secret}@@';\nGRANT ALL PRIVILEGES ON @@{DBName}@@.* TO '@@{MariaDBCred.username}@@'@'%';\nGRANT ALL PRIVILEGES ON @@{DBName}@@.* TO '@@{NUTANIX.username}@@'@'localhost';\nFLUSH PRIVILEGES;\nEOF","script_type":"sh","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Init DB content","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\nDIRNAME=`echo @@{GitRepo}@@ | awk -F\/ '{ print $(NF) }' | sed 's\/.git$\/\/'`\n\ncd tmp\/$DIRNAME\/@@{AppFolder}@@\/db\n\nmysql -u@@{NUTANIX.username}@@ -p@@{NUTANIX.secret}@@ @@{DBName}@@ < *.sql","script_type":"sh","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"9cebc9fd_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_delete","description":"System action for deleting an application. Deletes created VMs as well","runbook":{"name":"a77fadec_runbook","description":"","task_definition_list":[{"type":"DAG","name":"3e4a7300_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"3e4a7300_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_start","description":"System action for starting an application","runbook":{"name":"4f9f2067_runbook","description":"","task_definition_list":[{"type":"DAG","name":"ab70f3f9_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"ab70f3f9_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_stop","description":"System action for stopping an application","runbook":{"name":"4e1816db_runbook","description":"","task_definition_list":[{"type":"DAG","name":"05d67905_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"05d67905_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_restart","description":"System action for restarting an application","runbook":{"name":"b03bea93_runbook","description":"","task_definition_list":[{"type":"DAG","name":"c18dcf32_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"c18dcf32_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"user","name":"Dump DB","description":"","runbook":{"name":"42fa1a64_runbook","description":"","task_definition_list":[{"type":"DAG","name":"0dd4a892_dag","description":"","attrs":{"type":"","edges":[{"type":"","from_task_reference":{"name":"Create Dir","kind":"app_task"},"to_task_reference":{"name":"DumpDB","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"DumpDB","kind":"app_task"},"to_task_reference":{"name":"Clean old dumps","kind":"app_task"},"edge_type":"user_defined"}]},"child_tasks_local_reference_list":[{"name":"Create Dir","kind":"app_task"},{"name":"DumpDB","kind":"app_task"},{"name":"Clean old dumps","kind":"app_task"}],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Create Dir","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\nif [ -d dump ]\nthen\n    echo \"Already exists\"\nelse\n    mkdir dump\n    echo \"dump folder created\"\nfi","script_type":"sh","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"DumpDB","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\nDATE=`date +\"%Y%m%d_%H%M%S\"`\n\nmariadb-dump -p@@{NUTANIX.secret}@@ @@{DBName}@@ > dump\/@@{DBName}@@.$DATE.dump","script_type":"sh","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Clean old dumps","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\ncd dump\nls -t | sed -e '1,10d' | xargs -d '\\n' rm -f\n\necho \"Cleaned\"","script_type":"sh","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"0dd4a892_dag","kind":"app_task"},"variable_list":[]},"critical":false}],"depends_on_list":[],"port_list":[],"singleton":false,"tier":""},{"name":"Frontend","description":"","variable_list":[{"type":"LOCAL","name":"KUBECONFIG","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":false},"value":""},{"type":"LOCAL","name":"Namespace","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":false},"value":""},{"type":"LOCAL","name":"ImageName","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":false},"value":""},{"type":"LOCAL","name":"clean_app_name","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":false},"value":""},{"type":"LOCAL","name":"FQDN","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":false},"value":""}],"action_list":[{"type":"system","name":"action_create","description":"System action for creating an application","runbook":{"name":"d9fe0cad_runbook","description":"","task_definition_list":[{"type":"DAG","name":"8861bd4e_dag","description":"","attrs":{"type":"","edges":[{"type":"","from_task_reference":{"name":"Setup Variables","kind":"app_task"},"to_task_reference":{"name":"Create NS","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"Create NS","kind":"app_task"},"to_task_reference":{"name":"Crete Deployment","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"Crete Deployment","kind":"app_task"},"to_task_reference":{"name":"Create Service","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"Create Service","kind":"app_task"},"to_task_reference":{"name":"Create Ingress","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"Create Ingress","kind":"app_task"},"to_task_reference":{"name":"Create DNS entry","kind":"app_task"},"edge_type":"user_defined"}]},"child_tasks_local_reference_list":[{"name":"Setup Variables","kind":"app_task"},{"name":"Create NS","kind":"app_task"},{"name":"Crete Deployment","kind":"app_task"},{"name":"Create Service","kind":"app_task"},{"name":"Create Ingress","kind":"app_task"},{"name":"Create DNS entry","kind":"app_task"}],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"SET_VARIABLE","name":"Setup Variables","description":"","attrs":{"type":"","script":"#script\n\nprint(\"KUBECONFIG=\/home\/calm\/data\/kubeconfig\/@@{K8sCluster}@@.yaml\")\nprint(\"Namespace=calm-\"+re.sub(r'[^a-zA-Z0-9\\-]', '', \"@@{calm_application_name}@@\").lower())\nprint(\"clean_app_name=\"+re.sub(r'[^a-zA-Z0-9\\-]', '', \"@@{calm_application_name}@@\").lower())\nprint(\"FQDN=@@{ShortName}@@.ntnxlab.org\")","script_type":"static_py3","exit_status":[],"eval_scope":"local","eval_variables":["KUBECONFIG","Namespace","clean_app_name","FQDN"]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Create NS","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\necho @@{JUMPHOST.username}@@\n\neval \"$(\/home\/linuxbrew\/.linuxbrew\/bin\/brew shellenv)\"\n\nkubectl --kubeconfig=@@{KUBECONFIG}@@ create ns @@{Namespace}@@","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"JUMPHOST","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Crete Deployment","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\neval \"$(\/home\/linuxbrew\/.linuxbrew\/bin\/brew shellenv)\"\n\nkubectl --kubeconfig=@@{KUBECONFIG}@@ apply -n @@{Namespace}@@ -f - <<EOF\napiVersion: apps\/v1\nkind: Deployment\nmetadata:\n  name: @@{clean_app_name}@@\n  labels:\n    app: @@{clean_app_name}@@\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: @@{clean_app_name}@@\n  template:\n    metadata:\n      labels:\n        app: @@{clean_app_name}@@\n    spec:\n      containers:\n        - image: @@{Registry}@@@@{clean_app_name}@@:1.0\n          name: @@{clean_app_name}@@\n          env:\n          - name: DB_HOST\n            value: @@{Mariadb.address}@@\n          - name: DB_USERNAME\n            value: @@{MariaDBCred.username}@@\n          - name: DB_PASSWORD\n            value: @@{MariaDBCred.secret}@@\n          - name: DB_NAME\n            value: @@{DBName}@@\n          ports:\n            - containerPort: 8080\nEOF","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"JUMPHOST","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Create Service","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\neval \"$(\/home\/linuxbrew\/.linuxbrew\/bin\/brew shellenv)\"\n\nkubectl --kubeconfig=@@{KUBECONFIG}@@ apply -n @@{Namespace}@@ -f - <<EOF\napiVersion: v1\nkind: Service\nmetadata:\n  name: @@{clean_app_name}@@\nspec:\n  selector:\n    app: @@{clean_app_name}@@\n  ports:\n    - port: 80\n      targetPort: 8080\nEOF","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"JUMPHOST","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Create Ingress","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\neval \"$(\/home\/linuxbrew\/.linuxbrew\/bin\/brew shellenv)\"\n\nkubectl --kubeconfig=@@{KUBECONFIG}@@ apply -n @@{Namespace}@@ -f - <<EOF\napiVersion: networking.k8s.io\/v1\nkind: Ingress\nmetadata:\n  name: @@{clean_app_name}@@\n  annotations:\n    kubernetes.io\/tls-acme: \"true\"\n    traefik.ingress.kubernetes.io\/router.entrypoints: websecure\nspec:\n  rules:\n    - host: @@{FQDN}@@\n      http:\n        paths:\n          - backend:\n              service:\n                name: @@{clean_app_name}@@\n                port:\n                  number: 80\n            path: \/\n            pathType: Prefix\n  tls:\n    - hosts:\n        - @@{FQDN}@@\n      secretName: @@{clean_app_name}@@   \nEOF","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"JUMPHOST","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Create DNS entry","description":"","attrs":{"type":"","script":"#!\/bin\/bash -x\n\neval \"$(\/home\/linuxbrew\/.linuxbrew\/bin\/brew shellenv)\"\n\n# Get IP\nTARGETIP=`kubectl --kubeconfig=@@{KUBECONFIG}@@ get services -A | grep LoadBalancer | awk '{ print $5 }'`\n\necho \"TARGETIP found : $TARGETIP\"\n\ncd \/home\/calm\/git_resources\/DemoStuff\/CloudflareDNSScript\n.\/CloudflareDNSManagement.py ntnxlab.org add host @@{ShortName}@@ $TARGETIP","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"JUMPHOST","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"8861bd4e_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_delete","description":"System action for deleting an application. Deletes created VMs as well","runbook":{"name":"f9a4e1e6_runbook","description":"","task_definition_list":[{"type":"DAG","name":"c54f6756_dag","description":"","attrs":{"type":"","edges":[{"type":"","from_task_reference":{"name":"Delete ns","kind":"app_task"},"to_task_reference":{"name":"Delete DNS Entry","kind":"app_task"},"edge_type":"user_defined"}]},"child_tasks_local_reference_list":[{"name":"Delete ns","kind":"app_task"},{"name":"Delete DNS Entry","kind":"app_task"}],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Delete ns","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\neval \"$(\/home\/linuxbrew\/.linuxbrew\/bin\/brew shellenv)\"\n\nkubectl --kubeconfig=@@{KUBECONFIG}@@ delete ns @@{Namespace}@@","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"JUMPHOST","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Delete DNS Entry","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\ncd \/home\/calm\/git_resources\/DemoStuff\/CloudflareDNSScript\n.\/CloudflareDNSManagement.py ntnxlab.org delete host @@{ShortName}@@","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"JUMPHOST","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"c54f6756_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_start","description":"System action for starting an application","runbook":{"name":"ca8a75ec_runbook","description":"","task_definition_list":[{"type":"DAG","name":"99d34290_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"99d34290_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_stop","description":"System action for stopping an application","runbook":{"name":"de298014_runbook","description":"","task_definition_list":[{"type":"DAG","name":"75ad337e_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"75ad337e_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_restart","description":"System action for restarting an application","runbook":{"name":"1094c169_runbook","description":"","task_definition_list":[{"type":"DAG","name":"3655ee55_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"3655ee55_dag","kind":"app_task"},"variable_list":[]},"critical":false}],"depends_on_list":[],"port_list":[],"singleton":false,"tier":""}],"published_service_definition_list":[],"substrate_definition_list":[{"type":"AHV_VM","name":"Database","description":"","variable_list":[],"action_list":[],"create_spec":{"type":"","name":"@@{calm_application_name}@@-db","availability_zone_reference":null,"backup_policy":null,"cluster_reference":{"type":"","kind":"cluster","name":"DM3-POC082","uuid":"0005fed3-1b0b-6ad0-0000-00000002acdd"},"resources":{"type":"","nic_list":[{"type":"","nic_type":"NORMAL_NIC","subnet_reference":{"type":"","kind":"subnet","name":"","uuid":"f597d238-4099-468f-93aa-1c221dc939cd"},"network_function_nic_type":"INGRESS","mac_address":"","ip_endpoint_list":[],"network_function_chain_reference":null,"vpc_reference":null}],"power_state":"ON","guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":2,"memory_size_mib":4096,"gpu_list":[],"parent_reference":null,"hardware_clock_timezone":"","account_uuid":"38cf664a-d889-467c-acc4-5e19aff83a4c","guest_customization":{"type":"","cloud_init":{"type":"","meta_data":"","user_data":"#cloud-config \nusers:\n  - name: @@{NUTANIX.username}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\nchpasswd:\n  list: |\n    @@{NUTANIX.username}@@:@@{NUTANIX.secret}@@\n  expire: False\nssh_pwauth: true"},"sysprep":null},"boot_config":{"type":"","boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"mac_address":"","boot_type":"LEGACY"},"disk_list":[{"type":"","data_source_reference":{"type":"","kind":"image","name":"Rocky-9-5.qcow2","uuid":"86460e8b-aad9-4d39-ab18-624010d03b92"},"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"},"disk_size_mib":30720}],"serial_port_list":[]},"categories":{}},"os_type":"Linux","readiness_probe":{"login_credential_local_reference":{"name":"NUTANIX","kind":"app_credential"},"connection_type":"SSH","connection_port":22,"delay_secs":"60","retries":"5","address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","disable_readiness_probe":false,"connection_protocol":""}},{"type":"EXISTING_VM","name":"K8s_pods","description":"","variable_list":[],"action_list":[],"create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"jumphost.ntnxlab.org"},"os_type":"Linux","readiness_probe":{"login_credential_local_reference":{"name":"JUMPHOST","kind":"app_credential"},"connection_type":"SSH","connection_port":22,"delay_secs":"60","retries":"5","address":"@@{ip_address}@@","disable_readiness_probe":false,"connection_protocol":""}}],"package_definition_list":[{"type":"DEB","name":"Mariadb","description":"","variable_list":[],"action_list":[],"service_local_reference_list":[{"name":"Backend","kind":"app_service"}],"version":"","options":{"type":"","install_runbook":{"name":"603034fa_runbook","description":"","task_definition_list":[{"type":"DAG","name":"a9ac7e64_dag","description":"","attrs":{"type":"","edges":[{"type":"","from_task_reference":{"name":"Update OS","kind":"app_task"},"to_task_reference":{"name":"Install MariaDB","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"Install MariaDB","kind":"app_task"},"to_task_reference":{"name":"Enable MariaDB","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"Enable MariaDB","kind":"app_task"},"to_task_reference":{"name":"Clone Git","kind":"app_task"},"edge_type":"user_defined"}]},"child_tasks_local_reference_list":[{"name":"Update OS","kind":"app_task"},{"name":"Install MariaDB","kind":"app_task"},{"name":"Enable MariaDB","kind":"app_task"},{"name":"Clone Git","kind":"app_task"}],"variable_list":[],"target_any_local_reference":{"name":"Mariadb","kind":"app_package"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Update OS","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\nsudo yum update -y && sudo yum upgrade -y","script_type":"sh","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Install MariaDB","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\nsudo dnf list mariadb\n\nsudo dnf install mariadb mariadb-server git -y\n\nmariadb --version\n","script_type":"sh","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Enable MariaDB","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\nsudo systemctl enable mariadb\n\nsudo systemctl start mariadb","script_type":"sh","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Clone Git","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\nmkdir tmp\n\ncd tmp\n\ngit clone @@{GitRepo}@@","script_type":"sh","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"a9ac7e64_dag","kind":"app_task"},"variable_list":[]},"uninstall_runbook":{"name":"c4f52758_runbook","description":"","task_definition_list":[{"type":"DAG","name":"c0b37b75_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Mariadb","kind":"app_package"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"c0b37b75_dag","kind":"app_task"},"variable_list":[]},"upgrade_runbook":{}}},{"type":"DEB","name":"k8s_stuff","description":"","variable_list":[],"action_list":[],"service_local_reference_list":[{"name":"Frontend","kind":"app_service"}],"version":"","options":{"type":"","install_runbook":{"name":"d7818974_runbook","description":"","task_definition_list":[{"type":"DAG","name":"aa8038c7_dag","description":"","attrs":{"type":"","edges":[{"type":"","from_task_reference":{"name":"Create image","kind":"app_task"},"to_task_reference":{"name":"Push Image","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"Define ImageName","kind":"app_task"},"to_task_reference":{"name":"Create image","kind":"app_task"},"edge_type":"user_defined"}]},"child_tasks_local_reference_list":[{"name":"Define ImageName","kind":"app_task"},{"name":"Create image","kind":"app_task"},{"name":"Push Image","kind":"app_task"}],"variable_list":[],"target_any_local_reference":{"name":"k8s_stuff","kind":"app_package"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"SET_VARIABLE","name":"Define ImageName","description":"","attrs":{"type":"","script":"#script\n\nprint(\"ImageName=@@{Registry}@@\"+re.sub(r'[^a-zA-Z0-9\\-]', '', \"@@{calm_application_name}@@\").lower()+\":1.0\")","script_type":"static_py3","exit_status":[],"eval_scope":"local","eval_variables":["ImageName"]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"SET_VARIABLE","name":"Create image","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\ncd \/tmp\nrm -rf @@{calm_application_name}@@\nmkdir @@{calm_application_name}@@\ncd @@{calm_application_name}@@\ngit clone @@{GitRepo}@@\n\nDIRNAME=`echo @@{GitRepo}@@ | awk -F\/ '{ print $(NF) }' | sed 's\/.git$\/\/'`\n\ncd $DIRNAME\/@@{AppFolder}@@\n\nsudo docker build . -t @@{ImageName}@@\n\nsudo docker image list @@{ImageName}@@","script_type":"sh","exit_status":[],"eval_scope":"local","eval_variables":["KUBECONFIG"],"login_credential_local_reference":{"name":"JUMPHOST","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Push Image","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\nsudo docker push @@{ImageName}@@","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"JUMPHOST","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"aa8038c7_dag","kind":"app_task"},"variable_list":[]},"uninstall_runbook":{"name":"26f03b67_runbook","description":"","task_definition_list":[{"type":"DAG","name":"bba009ac_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"k8s_stuff","kind":"app_package"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"bba009ac_dag","kind":"app_task"},"variable_list":[]},"upgrade_runbook":{}}}],"app_profile_list":[{"name":"Default","description":"","variable_list":[{"type":"LOCAL","name":"DBName","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":false},"value":"myapp"},{"type":"EXEC_LOCAL","name":"AppFolder","description":"","regex":{"value":"^.*$","should_validate":false},"options":{"type":"EXEC","attrs":{"type":"EXEC","script":"#script\n\nfrom requests import request\n\ngitrepo=\"@@{GitRepo}@@\"\n\nheaders = {\n    'accept': 'application\/vnd.github.v3+json',\n}\n\napi_urltmp = gitrepo.replace(\"https:\/\/github.com\/\", \"https:\/\/api.github.com\/repos\/\")\napi_url=api_urltmp[:-4]\n\napi_url += \"\/contents\/\"\nresponse = request(\"GET\", api_url, headers=headers)\n\nif response.status_code == 200:\n    contents = json.loads(response.text)\n    folders = [item['name'] for item in contents if item['type'] == 'dir' and item['name'][-3:] == \"App\" ]\n\nprint(\",\".join(folders))","script_type":"static_py3","command_line_args":"","exit_status":[]}},"is_hidden":false,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":true},"value":""},{"type":"LOCAL","name":"GitRepo","description":"Enter .git file","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"Git Repo","attrs":{"type":""},"value":"https:\/\/github.com\/Golgautier\/demo-hybrid-app.git"},{"type":"LOCAL","name":"Registry","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":false},"value":"registry.ntnxlab.org\/nutanix\/"},{"type":"LOCAL","name":"ShortName","description":"You app will be evailable trough [this value].ntnxlab.org","regex":{"value":"[a-zA-Z0-9\\-]+","should_validate":true},"options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"URL Prefix","attrs":{"type":""},"editables":{"value":true},"value":""},{"type":"EXEC_LOCAL","name":"K8sCluster","description":"","options":{"type":"EXEC","attrs":{"type":"EXEC","script":"#!\/bin\/bash\n\ncd data\/kubeconfig \n\nls -m | sed s'\/\\.yaml\/\/g'","script_type":"sh","command_line_args":"","exit_status":[]},"exec_target_reference":{"name":"jump","kind":"app_endpoint"}},"is_hidden":false,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"Kubernetes Cluster","attrs":{"type":""},"editables":{"value":true},"value":""}],"action_list":[{"type":"user","name":"Database _ Create Dump","description":"","runbook":{"name":"dc6964b7_runbook","description":"","task_definition_list":[{"type":"DAG","name":"543cb474_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[{"name":"Req Dump","kind":"app_task"}],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"CALL_RUNBOOK","name":"Req Dump","description":"","attrs":{"type":"CALL_RUNBOOK","runbook_reference":{"name":"42fa1a64_runbook","kind":"app_runbook"},"inarg_list":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"543cb474_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"user","name":"Database _ Restore Dump","description":"","runbook":{"name":"0be0450d_runbook","description":"","task_definition_list":[{"type":"DAG","name":"3d13325b_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[{"name":"Restore Dump","kind":"app_task"}],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Restore Dump","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\nFILE=\"\"\n\nif [ \"@@{FileName}@@\" == \"\" ]\nthen\n    FILE=dump\/`ls -t dump\/|head -1`\nelse\n    FILE=dump\/@@{FileName}@@.dump\nfi\n\necho \"Dump file used will be : $FILE\"\n\nif [ ! -f $FILE ]\nthen\n    echo \"Error, requested dump does not exist\"\n    exit 2\nfi\n\nmysql -u @@{NUTANIX.username}@@ -p@@{NUTANIX.secret}@@ @@{DBName}@@ < $FILE","script_type":"sh","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"3d13325b_dag","kind":"app_task"},"variable_list":[{"type":"LOCAL","name":"FileName","description":"Let it empty to use last dump","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"Dump to restore","attrs":{"type":""},"editables":{"value":true},"value":""}]},"critical":false},{"type":"user","name":"Frontend _ Scale","description":"","runbook":{"name":"43b8a665_runbook","description":"","task_definition_list":[{"type":"DAG","name":"fb602fe8_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[{"name":"Scale","kind":"app_task"}],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Scale","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\neval \"$(\/home\/linuxbrew\/.linuxbrew\/bin\/brew shellenv)\"\n\nkubectl --kubeconfig=@@{KUBECONFIG}@@ apply -n @@{Namespace}@@ -f - <<EOF\napiVersion: apps\/v1\nkind: Deployment\nmetadata:\n  name: @@{clean_app_name}@@\n  labels:\n    app: @@{clean_app_name}@@\nspec:\n  replicas: @@{NumReplicas}@@\n  selector:\n    matchLabels:\n      app: @@{clean_app_name}@@\n  template:\n    metadata:\n      labels:\n        app: @@{clean_app_name}@@\n    spec:\n      containers:\n        - image: @@{Registry}@@@@{clean_app_name}@@:1.0\n          name: @@{clean_app_name}@@\n          env:\n          - name: DB_HOST\n            value: @@{Mariadb.address}@@\n          - name: DB_USERNAME\n            value: @@{MariaDBCred.username}@@\n          - name: DB_PASSWORD\n            value: @@{MariaDBCred.secret}@@\n          - name: DB_NAME\n            value: @@{DBName}@@\n          ports:\n            - name: web\n              containerPort: 8080\nEOF","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"JUMPHOST","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Frontend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"fb602fe8_dag","kind":"app_task"},"variable_list":[{"type":"LOCAL","name":"NumReplicas","description":"","regex":{"value":"^[\\d]*$","should_validate":true},"options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":false,"data_type":"BASE","val_type":"INT","label":"Number of replicas","attrs":{"type":""},"editables":{"value":true},"value":""}]},"critical":false},{"type":"user","name":"Database _ List avaiable dumps","description":"","runbook":{"name":"4199994f_runbook","description":"","task_definition_list":[{"type":"DAG","name":"64016997_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[{"name":"List","kind":"app_task"}],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"List","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\ncd dump\n\nls | sed 's\/\\.dump\/\/g'","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"NUTANIX","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Backend","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"64016997_dag","kind":"app_task"},"variable_list":[]},"critical":false}],"deployment_create_list":[{"type":"GREENFIELD","name":"deployment_3de80f9a","description":"","variable_list":[],"action_list":[],"depends_on_list":[],"min_replicas":"1","max_replicas":"1","default_replicas":"1","package_local_reference_list":[{"name":"Mariadb","kind":"app_package"}],"substrate_local_reference":{"name":"Database","kind":"app_substrate"},"published_service_local_reference_list":[]},{"type":"GREENFIELD","name":"deployment_8818ab33","description":"","variable_list":[],"action_list":[],"depends_on_list":[],"min_replicas":"1","max_replicas":"1","default_replicas":"1","package_local_reference_list":[{"name":"k8s_stuff","kind":"app_package"}],"substrate_local_reference":{"name":"K8s_pods","kind":"app_substrate"},"published_service_local_reference_list":[]}],"snapshot_config_list":[],"restore_config_list":[],"environment_reference_list":["3fd89834-4d67-eea3-0717-8e1bfd70706f"],"application_url":"","patch_list":[]}],"credential_definition_list":[{"type":"PASSWORD","name":"NUTANIX","description":"","username":"nutanix","secret":{"attrs":{"secret_reference":{},"is_secret_modified":false}},"cred_class":"static"},{"type":"PASSWORD","name":"MariaDBCred","description":"","username":"admin","secret":{"attrs":{"secret_reference":{},"is_secret_modified":false}},"cred_class":"static"},{"type":"PASSWORD","name":"JUMPHOST","description":"","username":"calm","secret":{"attrs":{"secret_reference":{},"is_secret_modified":false}},"cred_class":"static"}],"default_credential_local_reference":{"name":"NUTANIX","kind":"app_credential"},"type":"USER","client_attrs":{"deployment_3de80f9a":{"x":534,"y":597.5},"deployment_8818ab33":{"x":742.75,"y":598}}}},"api_version":"3.0","product_version":"4.0.0","metadata":{"last_update_time":"1739960046682305","creation_time":"1739802232547839","spec_version":12,"name":"HybridApp_VM-K8s","kind":"blueprint"},"contains_secrets":false}